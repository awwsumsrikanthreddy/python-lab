trigger: none

container:
  image: aquasec/aqua-scanner
  env:
    AQUA_KEY: $(AQUA_KEY)
    AQUA_SECRET: $(AQUA_SECRET)
    AZURE_TOKEN: $(AZURE_TOKEN)
    AQUA_URL: https://api.eu-1.supply-chain.cloud.aquasec.com
    CSPM_URL: https://eu-1.api.cloudsploit.com
    TRIVY_RUN_AS_PLUGIN: aqua
    # For http/https proxy configuration add env vars: HTTP_PROXY/HTTPS_PROXY, CA-CERT

steps:
- checkout: self
  fetchDepth: 0

- script: |
    trivy fs --scanners misconfig,vuln,secret .
    # Optional flags:
    # --severity UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL
    # --sast --reachability
    # --package-json / --dotnet-proj / --gradle
  displayName: Aqua Scanner

- task: CmdLine@2
  displayName: "SBOM Generation with Billy"
  inputs: 
    script: |-
      export BILLY_SERVER=https://billy.eu-1.codesec.aquasec.com
      curl -sLo install.sh https://download.codesec.aquasec.com/billy/install.sh
      curl -sLo install.sh.checksum https://github.com/argonsecurity/releases/releases/latest/download/install.sh.checksum
      
      if ! cat install.sh.checksum | sha256sum --check; then
        echo "install.sh checksum failed"
        exit 1
      fi

      BINDIR="." sh install.sh
      rm install.sh install.sh.checksum

      ./billy generate \
        --access-token $(System.AccessToken) \
        --aqua-key $(AQUA_KEY) \
        --aqua-secret $(AQUA_SECRET) \
        --cspm-url https://eu-1.api.cloudsploit.com \
        --artifact-path my-image-name:${versionEnv}
  env:
    versionEnv: $(Build.BuildId) # or your own version logic
